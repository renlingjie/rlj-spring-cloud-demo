---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by renlingjie.
--- DateTime: 2022/1/15 9:26 上午
---


-- 获取传入的key(即调用这个脚本的方法接收的参数：要限流的方法的特征)
local methodKey = KEYS[1]
redis.log(redis.LOG_DEBUG,'key is',methodKey) --这个会打印在Redis的控制台中
-- 调用传入脚本的限流参数
local limit = tonumber(ARGV[1])
-- 之后根据key拿到"正在执行的一类方法"的数量(如果key找不到/返回为空，说明这类方法没有执行中的，置为0)
local count = tonumber(redis.call('get',methodKey) or "0")
-- 看是否超限，没超限就可以执行，数量加1
if count + 1 > limit then
    return false --拒绝服务访问，限流
else
    -- 接受访问，同时调用redis的INCRBY方法，将methodKey对应的value(即count)加1
    redis.call("INCRBY",methodKey,1)
    -- 调用redis的EXPIRE方法设置过期时间(设置为1s)
    redis.call("EXPIRE",methodKey,1)
    return true --放行
end